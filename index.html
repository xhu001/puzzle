<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
body { 
  margin: 0; 
  background: #000; 
  overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
}
#container {
  position: relative;
  width: 100vw;
  height: 100vh;
}
button {
  position: fixed; 
  top: 20px; 
  left: 50%;
  transform: translateX(-50%);
  font-size: 18px; 
  padding: 12px 24px;
  z-index: 10;
  background: #007AFF;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
.mode-btns {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;
  display: none;
}
.mode-btns.active {
  display: flex;
  gap: 5px;
}
.mode-btn {
  background: #444;
  border: none;
  color: white;
  padding: 10px 15px;
  border-radius: 6px;
  font-size: 14px;
}
.mode-btn.active {
  background: #007AFF;
}
#controls {
  position: fixed;
  top: 140px;
  left: 10px;
  right: 10px;
  z-index: 10;
  display: none;
}
#controls.active {
  display: block;
}
.slider-group {
  background: rgba(0,0,0,0.85);
  padding: 12px;
  margin-bottom: 8px;
  border-radius: 8px;
  color: white;
  font-size: 14px;
}
.slider-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: bold;
}
.slider-group input[type="range"] {
  width: 100%;
  height: 30px;
}
#status {
  position: fixed;
  bottom: 20px;
  left: 10px;
  right: 10px;
  color: white;
  background: rgba(0,0,0,0.9);
  padding: 15px;
  border-radius: 8px;
  font-size: 14px;
  z-index: 10;
  line-height: 1.6;
  font-family: monospace;
}
canvas { 
  position: absolute; 
  top: 0; 
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}
video { 
  display: none; 
}
</style>
</head>
<body>
<div id="container">
  <button id="start">启动摄像头</button>
  
  <div class="mode-btns">
    <button class="mode-btn active" data-mode="original">原图</button>
    <button class="mode-btn" data-mode="threshold">阈值</button>
    <button class="mode-btn" data-mode="contours">轮廓</button>
  </div>
  
  <div id="controls">
    <div class="slider-group">
      <label>阈值: <span id="threshVal">127</span></label>
      <input type="range" id="threshold" min="50" max="200" value="127" step="1">
    </div>
    <div class="slider-group">
      <label>最小面积: <span id="minAreaVal">10</span> px²</label>
      <input type="range" id="minArea" min="1" max="200" value="10" step="1">
    </div>
    <div class="slider-group">
      <label>最大面积: <span id="maxAreaVal">10000</span> px²</label>
      <input type="range" id="maxArea" min="1000" max="50000" value="10000" step="100">
    </div>
  </div>
  
  <div id="status">等待 OpenCV 加载...</div>
  <video id="video" playsinline muted autoplay></video>
  <canvas id="canvas"></canvas>
</div>

<script>
let opencvReady = false;
let streaming = false;
let processingInterval = null;

// OpenCV Mats
let src, gray, thresh;

// 参数
let params = {
  displayMode: 'original',
  thresholdValue: 127,
  minArea: 10,
  maxArea: 10000
};

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d", { willReadFrequently: true });
const startBtn = document.getElementById("start");
const statusDiv = document.getElementById("status");
const controlsDiv = document.getElementById("controls");
const modeBtns = document.querySelector('.mode-btns');

// 模式切换
document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.onclick = function() {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    params.displayMode = this.dataset.mode;
  };
});

// 控制参数
document.getElementById("threshold").oninput = function() {
  params.thresholdValue = parseInt(this.value);
  document.getElementById("threshVal").textContent = this.value;
};

document.getElementById("minArea").oninput = function() {
  params.minArea = parseInt(this.value);
  document.getElementById("minAreaVal").textContent = this.value;
};

document.getElementById("maxArea").oninput = function() {
  params.maxArea = parseInt(this.value);
  document.getElementById("maxAreaVal").textContent = this.value;
};

// 动态加载 OpenCV.js
function loadOpenCV() {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'https://docs.opencv.org/4.x/opencv.js';
    script.async = true;
    
    script.onload = () => {
      if (typeof cv !== 'undefined') {
        cv.onRuntimeInitialized = () => {
          opencvReady = true;
          statusDiv.textContent = 'OpenCV 已加载\n点击按钮启动摄像头';
          resolve();
        };
      } else {
        reject(new Error('OpenCV 加载失败'));
      }
    };
    
    script.onerror = () => reject(new Error('OpenCV 脚本加载失败'));
    document.head.appendChild(script);
  });
}

// 启动摄像头
startBtn.onclick = async () => {
  if (!opencvReady) {
    alert('请等待 OpenCV 加载完成');
    return;
  }
  
  try {
    statusDiv.textContent = '正在启动摄像头...';
    
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { 
        facingMode: "environment",
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      },
      audio: false
    });
    
    video.srcObject = stream;
    video.onloadedmetadata = () => {
      video.play();
    };
    
    startBtn.style.display = 'none';
    modeBtns.classList.add('active');
    controlsDiv.classList.add('active');
    
  } catch (e) {
    statusDiv.textContent = '摄像头错误: ' + e.message;
    alert("无法访问摄像头: " + e.message);
  }
};

// 视频开始播放
video.addEventListener("playing", () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  
  try {
    src = new cv.Mat(canvas.height, canvas.width, cv.CV_8UC4);
    gray = new cv.Mat(canvas.height, canvas.width, cv.CV_8UC1);
    thresh = new cv.Mat(canvas.height, canvas.width, cv.CV_8UC1);
    
    streaming = true;
    
    if (processingInterval) clearInterval(processingInterval);
    processingInterval = setInterval(processFrame, 200); // 5 FPS 便于观察
    
  } catch (e) {
    statusDiv.textContent = '初始化错误: ' + e.message;
  }
});

function processFrame() {
  if (!streaming || !opencvReady) return;
  
  try {
    // 读取视频帧
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    cv.imread(canvas, src);
    
    // 显示原图模式
    if (params.displayMode === 'original') {
      cv.imshow(canvas, src);
      statusDiv.innerHTML = `分辨率: ${canvas.width} x ${canvas.height}\n模式: 原始画面\n\n请切换到"阈值"模式查看二值化效果`;
      return;
    }
    
    // 转灰度
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
    
    // 二值化
    cv.threshold(gray, thresh, params.thresholdValue, 255, cv.THRESH_BINARY);
    
    // 显示阈值模式
    if (params.displayMode === 'threshold') {
      cv.imshow(canvas, thresh);
      statusDiv.innerHTML = `分辨率: ${canvas.width} x ${canvas.height}\n模式: 二值化\n阈值: ${params.thresholdValue}\n\n白色=前景 黑色=背景\n调整阈值让拼图显示为白色`;
      return;
    }
    
    // 轮廓模式
    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();
    cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
    
    // 重新绘制原图
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    let total = contours.size();
    let validCount = 0;
    let areaList = [];
    
    for (let i = 0; i < total; i++) {
      let contour = contours.get(i);
      let area = cv.contourArea(contour);
      
      if (area >= params.minArea && area <= params.maxArea) {
        validCount++;
        areaList.push(Math.round(area));
        
        // 绘制所有有效轮廓
        ctx.strokeStyle = 'rgba(0, 255, 0, 0.9)';
        ctx.lineWidth = 3;
        ctx.fillStyle = 'rgba(0, 255, 0, 0.2)';
        ctx.beginPath();
        
        for (let j = 0; j < contour.data32S.length; j += 2) {
          let x = contour.data32S[j];
          let y = contour.data32S[j + 1];
          if (j === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.closePath();
        ctx.stroke();
        ctx.fill();
      }
    }
    
    // 排序面积列表
    areaList.sort((a, b) => b - a);
    let topAreas = areaList.slice(0, 5).join(', ');
    
    statusDiv.innerHTML = `分辨率: ${canvas.width} x ${canvas.height}\n模式: 轮廓检测\n\n总轮廓: ${total}\n有效轮廓: ${validCount}\n面积范围: ${params.minArea} - ${params.maxArea} px²\n最大5个面积: ${topAreas || '无'}\n\n${validCount === 0 ? '⚠️ 没检测到！调整阈值或面积范围' : '✅ 检测到 ' + validCount + ' 个物体'}`;
    
    contours.delete();
    hierarchy.delete();
    
  } catch (e) {
    console.error('错误:', e);
    statusDiv.textContent = '处理错误: ' + e.message;
  }
}

// 清理资源
window.addEventListener('beforeunload', () => {
  if (processingInterval) clearInterval(processingInterval);
  if (src) src.delete();
  if (gray) gray.delete();
  if (thresh) thresh.delete();
});

// 页面加载
loadOpenCV().catch(e => {
  statusDiv.textContent = 'OpenCV 加载失败，请刷新页面';
});
</script>
</body>
</html>
